<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cart | FOUR CHARIOTS</title>
  <meta name="description" content="Your shopping cart. Faith-driven gear, made to order." />
  <meta name="robots" content="noindex, nofollow" />

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='15' fill='%230b1a2a'/><text x='16' y='22' text-anchor='middle' font-size='18' font-weight='900' font-family='system-ui,sans-serif' fill='%23ffffff'>4C</text></svg>" />
  <link rel="icon" type="image/png" sizes="192x192" href="images/logo.png" />
  <link rel="apple-touch-icon" href="images/logo.png" />

  <style>
    :root{
      --bg:#ffffff;
      --text:#0a0a0a;
      --muted:#5f6368;
      --line:#e6e6e6;
      --soft:#f6f6f6;
      --ink:#0b1a2a;
      --btn:var(--ink);
      --btnText:#ffffff;
      --btnHover:#142a43;
      --max:1320px;
      --radius:0px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    a, button{ cursor:pointer; }
    html{ scroll-behavior:smooth; }
    html,body{ height:100%; }
    [id]{ scroll-margin-top:24px; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:var(--bg);
      line-height:1.35;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow-x: hidden;
    }
    a{ color:inherit; text-decoration:none; }
    a, button{ -webkit-tap-highlight-color:transparent; transition: opacity .15s ease, transform .08s ease; }
    a:active, button:active{ opacity:.7; transform:scale(0.98); }
    img{ max-width:100%; display:block; }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding: 18px 18px 70px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 14px 0;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      text-transform:uppercase;
      letter-spacing:-0.02em;
      font-weight:900;
    }
    .brand .wordmark{
      display:flex;
      flex-direction:column;
      line-height:1;
    }
    .brand .name{
      font-size:14px;
      letter-spacing:0.10em;
    }
    .mark{
      height:117px;
      width:auto;
      display:block;
    }

    .nav{
      display:flex;
      gap:18px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    .nav a{
      padding:8px 0;
      border-bottom:2px solid transparent;
    }
    .nav a:hover{
      color:var(--text);
      border-bottom-color:var(--text);
    }
    .ctaRow{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 12px 16px;
      font-size:13px;
      font-weight:800;
      letter-spacing:0.06em;
      text-transform:uppercase;
      border:1px solid var(--text);
      border-radius:var(--radius);
      background:transparent;
      color:var(--text);
      transition: background .2s ease, color .2s ease, border-color .2s ease, transform .2s ease;
      white-space:nowrap;
    }
    @media (hover: hover){
      .btn:hover{
        background:var(--text);
        color:var(--btnText);
        transform:scale(1.04);
      }
      .btn.primary:hover{
        background:var(--bg);
        color:var(--ink);
        border-color:var(--ink);
        transform:scale(1.04);
      }
    }
    .btn.primary{
      background:var(--btn);
      color:var(--btnText);
      border-color:var(--btn);
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .divider{ border-top:1px solid var(--line); }

    .memberBanner{
      background:var(--ink);
      color:#fff;
      text-align:center;
      padding:10px 16px;
      font-size:12px;
      font-weight:700;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }
    .memberBanner a{
      color:#fff;
      text-decoration:underline;
      text-underline-offset:3px;
      margin-left:6px;
      font-weight:900;
    }
    .memberBanner a:hover{ opacity:.8; }
    .shippingPromo{
      display:flex;
      align-items:center;
      gap:10px;
      padding:14px;
      border:1px dashed var(--ink);
      background:#f8fafc;
      margin-top:14px;
      font-size:12px;
      color:var(--ink);
      font-weight:700;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }
    .shippingPromo svg{ width:20px; height:20px; flex-shrink:0; }
    .shippingPromo a{
      text-decoration:underline;
      text-underline-offset:3px;
      font-weight:700;
      opacity:.7;
      transition: opacity .2s ease;
    }
    .shippingPromo a:hover{ opacity:1; }

    .menuBtn{
      display:none;
      border:none;
      background:none;
      padding:8px 10px;
      cursor:pointer;
      font-size:18px;
      line-height:1;
      color:var(--text);
    }

    /* Cart badge */
    .cartBtn{ position:relative; }
    .mobileCart{
      display:none;
      position:relative;
      background:none;
      border:none;
      padding:6px;
      cursor:pointer;
      color:var(--ink);
      text-decoration:none;
      align-items:center;
    }
    .cartBadge{
      position:absolute;
      top:-6px;
      right:-8px;
      background:var(--bg);
      color:var(--ink);
      font-size:10px;
      font-weight:900;
      min-width:18px;
      height:18px;
      border-radius:9px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0 5px;
      border:2px solid var(--ink);
    }

    /* Page hero */
    .pageHero{
      padding: 28px 0 18px;
      max-width: 780px;
    }
    .pageHero h1{
      margin:0;
      font-size: 20px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-weight:900;
      color:var(--ink);
    }
    .pageHero .intro{
      margin:12px 0 0;
      font-size:15px;
      color:var(--muted);
      line-height:1.55;
      max-width:50ch;
    }

    /* Cart layout */
    .cartWrap{
      max-width:800px;
      margin:0 auto;
    }

    /* Cart items */
    .cartList{
      display:flex;
      flex-direction:column;
      gap:0;
    }
    .cartItem{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:18px;
      padding:20px 0;
      border-bottom:1px solid var(--line);
      align-items:start;
      position:relative;
      cursor:pointer;
    }
    .cartItem:first-child{
      border-top:1px solid var(--line);
    }
    .itemImage{
      aspect-ratio:1;
      background:var(--soft);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .itemImage img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .itemInfo{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .itemTitle{
      margin:0;
      font-size:15px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:-0.01em;
      color:var(--ink);
      white-space:nowrap;
    }
    .itemLink{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:18px;
      color:inherit;
      text-decoration:none;
      align-items:start;
    }
    .itemLink::after{
      content:"";
      position:absolute;
      inset:0;
      z-index:0;
    }
    .itemActions{
      position:relative;
      z-index:1;
    }
    .itemVariant{
      font-size:12px;
      color:var(--muted);
    }
    .itemLimited{
      font-size:11px;
      color:var(--muted);
      margin-top:3px;
      opacity:.7;
    }
    .itemPrice{
      font-size:14px;
      font-weight:800;
      color:var(--ink);
      margin-top:4px;
    }
    .itemActions{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
    }
    .qtyControl{
      display:flex;
      align-items:center;
      border:1px solid var(--line);
    }
    .qtyBtn{
      width:32px;
      height:32px;
      border:none;
      background:var(--bg);
      font-size:14px;
      font-weight:700;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background .15s ease;
    }
    .qtyBtn:hover{ background:var(--soft); }
    .qtyVal{
      width:32px;
      text-align:center;
      font-size:13px;
      font-weight:800;
      color:var(--ink);
      border-left:1px solid var(--line);
      border-right:1px solid var(--line);
      line-height:32px;
    }
    .removeBtn{
      border:none;
      background:none;
      padding:0;
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      text-decoration:underline;
      text-underline-offset:3px;
      transition:color .2s ease;
      font-family:var(--font);
    }
    .removeBtn:hover{ color:var(--text); }

    /* Cart summary */
    .cartSummary{
      margin-top:24px;
      padding:24px;
      border:1px solid var(--line);
      background:var(--soft);
    }
    .summaryRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 0;
      font-size:13px;
      color:var(--muted);
    }
    .summaryRow.total{
      padding-top:14px;
      margin-top:8px;
      border-top:1px solid var(--line);
      font-size:16px;
      font-weight:900;
      color:var(--ink);
    }
    .checkoutBtn{
      width:100%;
      margin-top:18px;
      padding:16px;
      font-size:14px;
    }
    .checkoutError{
      font-size:12px;
      color:#8b2020;
      margin-top:8px;
      display:none;
      text-align:center;
    }
    .checkoutNote{
      margin:10px 0 0;
      font-size:11px;
      color:var(--muted);
      text-align:center;
    }
    .foundationMsg{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      margin:12px 0 0;
      line-height:1.5;
    }
    .itemPriceOld{
      font-size:12px;
      color:var(--muted);
      text-decoration:line-through;
      margin-right:6px;
    }

    /* Empty state */
    .emptyCart{
      text-align:center;
      padding:80px 20px;
    }
    .emptyCart h2{
      margin:0;
      font-size:clamp(20px, 3vw, 28px);
      font-weight:950;
      text-transform:uppercase;
      letter-spacing:-0.02em;
      color:var(--ink);
    }
    .emptyCart p{
      margin:12px 0 0;
      font-size:14px;
      color:var(--muted);
      line-height:1.55;
      max-width:40ch;
      margin-left:auto;
      margin-right:auto;
    }
    .emptyCart .btn{
      margin-top:24px;
    }

    /* Footer */
    footer{
      margin-top: 34px;
      padding-top: 18px;
      border-top:1px solid var(--line);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color:var(--muted);
      font-size:13px;
    }
    footer .links{ display:flex; gap:14px; flex-wrap:wrap; }
    footer .links a:hover{ color:var(--text); }

    /* Fade animation */
    .fade-up{
      opacity:0;
      transform:translateY(24px);
      transition: opacity .7s cubic-bezier(.16,1,.3,1), transform .7s cubic-bezier(.16,1,.3,1);
    }
    .fade-up.visible{
      opacity:1;
      transform:translateY(0);
    }

    @media (max-width: 980px){
      .wrap{ padding: 14px 14px 50px; }
      .brand .tag{ display:none; }
      .menuBtn{ display:block; }
      .nav{
        display:none;
        position:absolute;
        top:100%;
        left:-18px;
        right:-18px;
        background:var(--bg);
        flex-direction:column;
        padding:0;
        z-index:100;
        border-bottom:none;
      }
      .nav.open{ display:flex; }
      .nav a{
        padding:12px 18px;
        border-bottom:1px solid var(--line);
        width:100%;
      }
      .nav a:last-child{ border-bottom:none; }
      .nav a.navActive,
      .nav a:hover{
        border-bottom-color:var(--line);
      }
      .nav a.navActive{
        color:var(--text);
        font-weight:600;
      }
      .navOverlay{
        display:none;
        position:fixed;
        top:0;left:0;right:0;bottom:0;
        background:rgba(0,0,0,.35);
        z-index:99;
      }
      .navOverlay.open{ display:block; }
      .ctaRow{ display:none; }
      .mobileCart{ display:flex !important; }
      .topbar{ position:relative; }
      .pageHero{ padding: 20px 0 14px; }
    }

    @media (max-width: 640px){
      .mark{ height: 72px; }
      .topbar{ padding: 10px 0; }
      .nav{ left:-14px; right:-14px; }
      .nav a{ padding:12px 14px; }
      .brand .name{ font-size: 12px; }
      .cartItem{
        grid-template-columns: 80px 1fr;
        gap:12px;
      }
      .itemActions{
        grid-column: 1 / -1;
        flex-direction:row;
        justify-content:space-between;
        align-items:center;
        padding-top:12px;
        border-top:1px solid var(--line);
      }
      .cartSummary{ padding:18px; }
      .emptyCart{ padding:60px 16px; }
      footer{
        margin-top:24px;
        padding-top:14px;
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
        font-size:12px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap" id="top">
    <div class="topbar">
      <a class="brand" href="index.html">
        <img class="mark" src="images/logo.png" alt="Four Chariots logo" />
        <span class="wordmark">
          <span class="name">FOUR CHARIOTS</span>
        </span>
      </a>

      <nav class="nav" aria-label="Site navigation">
        <a href="shop.html">Shop</a>
        <a href="drop.html">The Drop</a>
        <a href="membership.html">Membership</a>
        <a href="about.html">About</a>
        <a href="support.html">Support</a>
      </nav>

      <div class="navOverlay" id="navOverlay"></div>

      <a class="mobileCart cartBtn" href="cart.html" aria-label="Cart"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg><span class="cartBadge" id="cartBadgeMobile" style="display:none;">0</span></a>
      <button class="menuBtn" aria-label="Toggle menu" onclick="document.querySelector('.nav').classList.toggle('open');document.getElementById('navOverlay').classList.toggle('open')">&#9776;</button>

      <div class="ctaRow">
        <a class="btn" href="shop.html">Shop</a>
        <a class="btn primary cartBtn" href="cart.html" id="cartBtn">Cart <span class="cartBadge" id="cartBadge" style="display:none;">0</span></a>
      </div>
    </div>

    <div class="divider"></div>

    <div class="pageHero fade-up">
      <h1>Your Cart</h1>
    </div>

    <div class="cartWrap" id="cartContent">
      <!-- Rendered by JS -->
    </div>

    <footer>
      <div>&copy; <span id="year"></span> FOUR CHARIOTS</div>
      <div class="links">
        <a href="mailto:support@4chariots.com">Contact</a>
        <a href="YOUR_INSTAGRAM_URL_HERE" target="_blank" rel="noopener">Instagram</a>
      </div>
    </footer>
  </div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const SUPABASE_URL  = "https://txeemijqgqomfclezonf.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4ZWVtaWpxZ3FvbWZjbGV6b25mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NjkzMjgsImV4cCI6MjA4NjM0NTMyOH0.boeu2dy3J-L09LRKQrRWPSvTPevynff5ZVwpeaT8oYM";

    /* ── Cart API ── */
    function getCart() {
      try {
        const raw = localStorage.getItem("fc_cart");
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }

    function saveCart(items) {
      try { localStorage.setItem("fc_cart", JSON.stringify(items)); } catch {}
    }

    function removeFromCart(productId, variantId) {
      const cart = getCart().filter(
        i => !(String(i.productId) === String(productId) && String(i.variantId) === String(variantId))
      );
      saveCart(cart);
      return cart;
    }

    function updateCartQty(productId, variantId, qty) {
      const cart = getCart();
      const item = cart.find(i => String(i.productId) === String(productId) && String(i.variantId) === String(variantId));
      if (!item) return cart;
      if (qty <= 0) return removeFromCart(productId, variantId);
      item.quantity = Math.min(qty, 10);
      saveCart(cart);
      return cart;
    }

    function getCartCount() {
      return getCart().reduce((s, i) => s + i.quantity, 0);
    }

    function getCartTotal() {
      return getCart().reduce((s, i) => s + i.price * i.quantity, 0);
    }

    /* ── Foundation Set logic ── */
    function getCoreItemCount(cart) {
      return cart.filter(i => String(i.productId).includes("core")).reduce((s, i) => s + i.quantity, 0);
    }

    function isFoundationSet(cart) {
      return getCoreItemCount(cart) >= 4;
    }

    function getCartTotalWithDiscount(cart) {
      const foundationActive = isFoundationSet(cart);
      return cart.reduce((s, i) => {
        const isCore = String(i.productId).includes("core");
        const multiplier = (foundationActive && isCore) ? 0.9 : 1;
        return s + Math.round(i.price * multiplier) * i.quantity;
      }, 0);
    }

    function getFoundationSavings(cart) {
      return getCartTotal() - getCartTotalWithDiscount(cart);
    }

    function formatPrice(cents) {
      return "$" + (Number(cents || 0) / 100).toFixed(2);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    /* ── Badge ── */
    function updateCartBadge() {
      const count = getCartCount();
      document.querySelectorAll("#cartBadge, #cartBadgeMobile").forEach(badge => {
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = "inline-flex";
        } else {
          badge.style.display = "none";
        }
      });
    }

    /* ── Render ── */
    function renderCart() {
      const cart = getCart();
      const el = document.getElementById("cartContent");

      if (!cart.length) {
        el.innerHTML = `
          <div class="emptyCart fade-up">
            <h2>Your cart is empty</h2>
            <p>Add some faith-driven gear to get started. Every piece is made to order, just for you.</p>
            <a class="btn primary" href="drop.html">Shop the Drop</a>
          </div>
        `;
      } else {
        const coreCount = getCoreItemCount(cart);
        const foundationActive = isFoundationSet(cart);
        const discountedTotal = getCartTotalWithDiscount(cart);
        const savings = getFoundationSavings(cart);

        el.innerHTML = `
          <div class="cartList fade-up" id="cartList">
            ${cart.map(item => {
              const isCore = String(item.productId).includes("core");
              const discountedPrice = (foundationActive && isCore) ? Math.round(item.price * 0.9) : item.price;
              const showStrike = foundationActive && isCore;
              const pidMap = {"forgiven-core":"forgiven.html","chosen-core":"chosen.html","grateful-core":"grateful.html","unashamed-core":"unashamed.html","unshaken-drop-001":"drop.html","fc-horse-emblem-mug":"mug.html","fc-foundation-seal-sticker":"sticker.html"};
              const itemUrl = pidMap[item.productId] || "shop.html";
              return `
              <div class="cartItem" data-pid="${escapeHtml(item.productId)}" data-vid="${item.variantId}">
                <a href="${itemUrl}" class="itemLink">
                  <div class="itemImage">
                    <img src="${escapeHtml(item.imageUrl)}" alt="${escapeHtml(item.title)}" loading="lazy" />
                  </div>
                  <div class="itemInfo">
                    <h3 class="itemTitle">${escapeHtml(item.title)}</h3>
                    <div class="itemVariant">
                      ${item.color ? escapeHtml(item.color) : ""}${item.color && item.size ? " &middot; " : ""}${item.size ? escapeHtml(item.size) : ""}
                    </div>
                    ${String(item.productId).includes("drop") ? '<div class="itemLimited">Individually numbered release · Limited to 66</div>' : String(item.productId).includes("core") ? '<div class="itemLimited">Core Collection</div>' : ""}
                    <div class="itemPrice">${showStrike ? '<span class="itemPriceOld">' + formatPrice(item.price) + '</span>' : ''}${formatPrice(discountedPrice)}</div>
                  </div>
                </a>
                <div class="itemActions">
                  <div class="qtyControl">
                    <button class="qtyBtn qtyMinus" aria-label="Decrease quantity">&minus;</button>
                    <span class="qtyVal">${item.quantity}</span>
                    <button class="qtyBtn qtyPlus" aria-label="Increase quantity">+</button>
                  </div>
                  <button class="removeBtn">Remove</button>
                </div>
              </div>
            `;}).join("")}
          </div>

          ${coreCount === 3 ? '<p class="foundationMsg">Three Core pieces selected. Add a fourth Core piece to get 10% off all Core items.</p>' : ''}
          ${foundationActive ? '<p class="foundationMsg">Foundation Set complete · 10% Core pricing active</p>' : ''}

          <div class="cartSummary fade-up" style="transition-delay:.08s">
            <div class="summaryRow">
              <span>Subtotal</span>
              <span id="subtotal">${formatPrice(discountedTotal)}</span>
            </div>
            ${foundationActive ? '<div class="summaryRow"><span>Foundation Set discount</span><span>−' + formatPrice(savings) + '</span></div>' : ''}
            <div class="summaryRow">
              <span>Shipping</span>
              <span>Calculated at checkout</span>
            </div>
            <div class="summaryRow total">
              <span>Total</span>
              <span id="total">${formatPrice(discountedTotal)}</span>
            </div>
            <button class="btn primary checkoutBtn" id="checkoutBtn">Proceed to Checkout</button>
            <div class="checkoutError" id="checkoutError"></div>
            <p class="checkoutNote">Secure checkout via Stripe</p>
            <div class="shippingPromo">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 18H3a1 1 0 01-1-1V7a1 1 0 011-1h10v11m0-11h3l3 4v7a1 1 0 01-1 1h-2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>
              <span>Members receive free shipping on limited Drop releases. <a href="membership.html">Become a member</a></span>
            </div>
          </div>
        `;

        bindCartControls();
        bindCheckout();
      }

      updateCartBadge();

      requestAnimationFrame(() => {
        el.querySelectorAll(".fade-up").forEach(e => e.classList.add("visible"));
      });
    }

    /* ── Item controls ── */
    function bindCartControls() {
      document.querySelectorAll(".cartItem").forEach(row => {
        const pid = row.dataset.pid;
        const vid = row.dataset.vid;

        row.querySelector(".qtyMinus").addEventListener("click", () => {
          const current = parseInt(row.querySelector(".qtyVal").textContent);
          if (current > 1) {
            updateCartQty(pid, vid, current - 1);
            renderCart();
          }
        });

        row.querySelector(".qtyPlus").addEventListener("click", () => {
          const current = parseInt(row.querySelector(".qtyVal").textContent);
          if (current < 10) {
            updateCartQty(pid, vid, current + 1);
            renderCart();
          }
        });

        row.querySelector(".removeBtn").addEventListener("click", () => {
          removeFromCart(pid, vid);
          renderCart();
        });
      });
    }

    /* ── Checkout ── */
    function bindCheckout() {
      const btn = document.getElementById("checkoutBtn");
      if (!btn) return;

      btn.addEventListener("click", async () => {
        const cart = getCart();
        if (!cart.length) return;

        const item = cart[0];

        btn.disabled = true;
        btn.textContent = "Opening checkout...";

        try {
          const res = await fetch(`${SUPABASE_URL}/functions/v1/create_checkout`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${SUPABASE_ANON}`,
              "apikey": SUPABASE_ANON
            },
            body: JSON.stringify({
              product_id: item.productId,
              variant_id: item.variantId,
              quantity: item.quantity
            })
          });

          const data = await res.json();

          const errEl = document.getElementById("checkoutError");
          if (!res.ok || !data.url) {
            if(errEl){ errEl.textContent = "Checkout failed. Please try again."; errEl.style.display = "block"; }
            btn.disabled = false;
            btn.textContent = "Proceed to Checkout";
            return;
          }

          removeFromCart(item.productId, item.variantId);
          window.location.href = data.url;
        } catch (err) {
          console.error("Checkout error:", err);
          const errEl = document.getElementById("checkoutError");
          if(errEl){ errEl.textContent = "Checkout error. Please try again."; errEl.style.display = "block"; }
          btn.disabled = false;
          btn.textContent = "Proceed to Checkout";
        }
      });
    }

    /* ── Nav ── */
    document.querySelectorAll(".nav a").forEach(a => {
      a.addEventListener("click", () => {
        document.querySelector(".nav").classList.remove("open");
        document.getElementById("navOverlay").classList.remove("open");
      });
    });
    document.getElementById("navOverlay").addEventListener("click", () => {
      document.querySelector(".nav").classList.remove("open");
      document.getElementById("navOverlay").classList.remove("open");
    });

    /* ── Init ── */
    renderCart();
  </script>
</body>
</html>
